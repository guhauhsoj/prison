---
title: "Final Analysis"
author: "J.E. Hug"
date: "5/11/2021"
output: html_document
---

```{r setup, include=TRUE}
library(tidyverse)
library(furrr)
library(readxl)
library(magrittr)
library(gee)
library(lme4)
library(glmnet)
```


# The Cleaning of the initial data

```{r prison data}
# read in prison data
prison <- read.csv(file = "./data/california_jail_survey_1995_2020_csv/california_jail_county_monthly_1995_2020.csv")

# San Francisco county has no revenue
prison %<>% filter(census_county_name !=  "San Francisco County") %>% 
  filter(year <= 2019 & year >=2005)

# group by county and aggregate into yearly data

prisonByCounty <- prison %>% 
  filter(year <= 2019 & year >=2005)

# now can aggregate by variable into yearly data


prisonclean <- prisonByCounty %>% group_by(fips_county_code,year) %>%
  select(-c(jurisdiction,month,date,census_county_name,fips_state_code,fips_state_county_code)) %>% 
  summarise_all(.funs = mean)


```


```{r revenue data}
# make a county FIPS column that we can join on
countiesrevenues <-
  c("Alameda",
    "Amador",
    "Butte",
    "Calaveras",
    "Colusa",
    "Contra Costa",
    "Del Norte",
    "El Dorado",
    "Fresno",
    "Glenn",
    "Humboldt",
    "Imperial",
    "Inyo",
    "Kern",
    "Kings",
    "Lake",
    "Lassen",
    "Los Angeles",
    "Madera",
    "Marin",
    "Mariposa",
    "Mendocino",
    "Merced",
    "Modoc" ,
    "Mono"   ,
    "Monterey"     ,
    "Napa" ,
    "Nevada" ,
    "Orange"      ,
    "Placer"    ,
    "Plumas"    ,
    "Riverside" ,
    "Sacramento"     ,
    "San Benito",
    "San Bernardino" ,
    "San Diego"  ,
    "San Joaquin",
    "San Luis Obispo" ,
    "San Mateo"  ,
    "Santa Barbara",
    "Santa Clara" ,
    "Santa Cruz",
    "Shasta"    ,
    "Sierra"  ,
    "Siskiyou"  ,
    "Solano"     ,
    "Sonoma",
    "Stanislaus"     ,
    "Sutter"  ,
    "Tehama"     ,
    "Trinity"      ,
    "Tulare"     ,
    "Tuolumne" ,
    "Ventura",
    "Yolo",
    "Yuba"
  )

countyFIPS <- sort(unique(prison$fips_county_code))

countyFIPStable <- data.frame(Entity.Name = countiesrevenues,fips_county_code = countyFIPS)

revenue <- read.csv(file = "./data/County_Revenues_Per_Capita.csv")

revenue %<>% filter(Entity.Name!=  "Alpine") %>% 
  filter(Fiscal.Year <= 2019 & Fiscal.Year >=2005) %>% 
  mutate(year = Fiscal.Year) %>% select(-Fiscal.Year)

revenueclean <- inner_join(revenue,countyFIPStable, by = c("Entity.Name"))

```



```{r gdp data}
gdpcalif <- read.csv("./data/gdpcalif.csv")

gdpcalifclean <- gdpcalif %>% filter(Description == "All industry total") %>% 
  mutate(fips_county_code=as.numeric(GeoFIPS)-6000) %>% 
  filter(fips_county_code != 0) %>% 
  select(-c(Description,Unit,Region,TableName,GeoFIPS,GeoName,
            IndustryClassification, LineCode)) %>% 
  pivot_longer(cols=-c(fips_county_code)) %>% rename(GDP = value) %>% 
  mutate(year =as.numeric(str_split(name,"X",simplify = TRUE)[str_split(name,"X",simplify = TRUE)!= ""])) %>% 
  filter(year <= 2019 & year >=2005) %>% mutate(GDP = as.numeric(GDP)) %>% 
  select(-name)

```






```{r}
# Put all 3 datasets together

revAndGDP <- inner_join(gdpcalifclean,revenueclean,by = c("fips_county_code","year"))

combinedData <- inner_join(revAndGDP,prisonclean,by = c("fips_county_code","year"))

# cut variables with all NA
combinedData %<>%  mutate(GDP.Per.Capita = GDP/Estimated.Population) %>%
  select(-c(avg_inmate_need_reg_med_attent,adp_of_maximum_security_inmates,
            adp_of_medium_security_inmates,avg_inmates_get_mental_heath_bed,
            total_juv_in_custody,avg_own_inmate_housed_elsewhere,
            avg_fed_inmate_housed_contract,avg_state_inmate_housed_contract,
            avg_local_inmate_housed_contract, avg_inmate_wait_transport_prison,
            adp_of_minimum_security_inmates, avg_inmates_get_medical_bed,
            avg_inmates_need_reg_ment_health,day_of_highest_count))

summary(combinedData)

# standardized
combinedDataal <- combinedData %>% select(-
    c(fips_county_code,
    GDP,
    year,
    Entity.Name,
    Total.Revenues,
    Estimated.Population,
    Revenues.Per.Capita,
    GDP.Per.Capita,
    highest_inmate_count)) %>% 
  mutate_all(function(x) x/combinedData$highest_inmate_count) %>% 
  mutate(fips_county_code = combinedData$fips_county_code,year = combinedData$year)

combinedDataal

combinedStandard <- inner_join(revAndGDP,combinedDataal, by = c("fips_county_code","year")) %>% 
  mutate(GDP.Per.Capita = GDP/Estimated.Population)





# response
# a) GDPpc
# b)  Revpc
# c) Mental health one standardized

# 1. Naive linear regression 

formula1 <- log(GDP.Per.Capita) ~ avg_daily_pop_unsentenced_male + avg_daily_pop_unsentenced_female+avg_daily_pop_sentenced_male+
  avg_daily_pop_sentenced_male+ avg_daily_pop_sentenced_female +  avg_daily_pop_total_jurisdiction+
  avg_felony_inmate_unsentenced  +  avg_felony_inmate_sentenced  +   avg_felony_inmate_total


formula2 <- log(Revenues.Per.Capita) ~ avg_daily_pop_unsentenced_male + avg_daily_pop_unsentenced_female+avg_daily_pop_sentenced_male+
  avg_daily_pop_sentenced_male+ avg_daily_pop_sentenced_female +  avg_daily_pop_total_jurisdiction+
  avg_felony_inmate_unsentenced  +  avg_felony_inmate_sentenced  +   avg_felony_inmate_total


formula3 <- num_new_mental_health_cases ~ avg_daily_pop_unsentenced_male + avg_daily_pop_unsentenced_female+avg_daily_pop_sentenced_male+
  avg_daily_pop_sentenced_male+ avg_daily_pop_sentenced_female +  avg_daily_pop_total_jurisdiction+
  avg_felony_inmate_unsentenced  +  avg_felony_inmate_sentenced  +   avg_felony_inmate_total

colnames(combinedStandard)

# heteroskedasticity???
lm1 <- lm(formula1, data = combinedStandard)
summary(lm1)


lm2 <- lm(formula2, data = combinedStandard)
summary(lm2)

lm3 <-lm(formula3, data = combinedStandard)
summary(lm3)


# 2. Lasso or Ridge (glmnet)

lassocov <- combinedStandard %>% 
  select(avg_daily_pop_unsentenced_male ,avg_daily_pop_unsentenced_female,avg_daily_pop_sentenced_male,
  avg_daily_pop_sentenced_male, avg_daily_pop_sentenced_female ,  avg_daily_pop_total_jurisdiction,
  avg_felony_inmate_unsentenced  ,  avg_felony_inmate_sentenced  ,   avg_felony_inmate_total)

bm1 <- na.omit(cbind(log(combinedStandard$GDP),as.matrix(lassocov)))

lass1 <- glmnet(y= bm1[,1], x= bm1[,2:ncol(bm1)], alpha = 1)
lambda=cv.glmnet(bm1[,2:ncol(bm1)], bm1[,1])$lambda.1se


library(selectiveInference)

selinf1 <- fixedLassoInf(x = bm1[,2:ncol(bm1)],y= bm1[,1], beta = coef(lass1,s=lambda/nrow(bm1))[-1],lambda = lambda)

coef(lass1,s=lambda/nrow(bm1))
colnames(combinedStandard)
# 3. GEE (gee package)

gee1 <- gee(formula1, data = combinedStandard, id = fips_county_code,corstr = "independence")
summary(gee1)


gee2 <- gee(formula2, data = combinedStandard, id = fips_county_code ,corstr = "independence")
summary(gee2)

gee3 <- gee(formula3, data = combinedStandard, id = fips_county_code,corstr = "independence" )
summary(gee3)


# 4. MLM (lme4 package)


mformula1 <- log(GDP.Per.Capita) ~ (1|fips_county_code)+avg_daily_pop_unsentenced_male + avg_daily_pop_unsentenced_female+avg_daily_pop_sentenced_male+
  avg_daily_pop_sentenced_male+ avg_daily_pop_sentenced_female +  avg_daily_pop_total_jurisdiction+
  avg_felony_inmate_unsentenced  +  avg_felony_inmate_sentenced  +   avg_felony_inmate_total


mformula2 <- log(Revenues.Per.Capita) ~ (1|fips_county_code)+avg_daily_pop_unsentenced_male + avg_daily_pop_unsentenced_female+avg_daily_pop_sentenced_male+
  avg_daily_pop_sentenced_male+ avg_daily_pop_sentenced_female +  avg_daily_pop_total_jurisdiction+
  avg_felony_inmate_unsentenced  +  avg_felony_inmate_sentenced  +   avg_felony_inmate_total


mformula3 <- num_new_mental_health_cases ~ (1|fips_county_code)+avg_daily_pop_unsentenced_male + avg_daily_pop_unsentenced_female+avg_daily_pop_sentenced_male+
  avg_daily_pop_sentenced_male+ avg_daily_pop_sentenced_female +  avg_daily_pop_total_jurisdiction+
  avg_felony_inmate_unsentenced  +  avg_felony_inmate_sentenced  +   avg_felony_inmate_total

mlm1 <- lmer(mformula1,data = combinedStandard)
summary(mlm1)

mlm2 <- lmer(mformula2,data = combinedStandard)
summary(mlm2)

mlm3 <- lmer(mformula3,data = combinedStandard)
summary(mlm3)



# standardize all coefficients with the prison population

```







